## Init Example: Override the generated FireLens config, enable buffer settings, and inject ECS Metadata

### Use Cases

This example fulfills the following use cases:
* Deploy the AWS for Fluent Bit vended init image from the AWS for Fluent Bit Public ECR repo directly; no need to maintain your own custom Fluent Bit image.
* Store and source all Fluent Bit configuration in S3.
* Limit Fluent Bit memory and disk usage with buffer settings for all inputs. 
* Collect stdout logs from containers in your ECS task using customized configuration, rather than the default generated FireLens stdout log collection configuration.
* Inject specific ECS task metadata into your logs.

### Why override the default generated FireLens input configuration?

Please read the [Fluent Bit Out of Memory Kill Prevention Guide](https://github.com/aws-samples/amazon-ecs-firelens-examples/tree/mainline/examples/fluent-bit/oomkill-prevention#full-firelens-configuration-examples). It discusses settings to limit the memory usage of the Fluent Bit process and enable file buffering. These settings are specified on the input definition; in [FireLens the input configuration that collects stdout logs is autogenerated](https://aws.amazon.com/blogs/containers/under-the-hood-firelens-for-amazon-ecs-tasks/) by ECS. Therefore, enabling buffer control settings requires [overriding the generated FireLens input configuration](https://aws.amazon.com/blogs/containers/how-to-set-fluentd-and-fluent-bit-input-parameters-in-firelens/). 

The generated FireLens configuration includes a filter to inject ECS metadata into logs, if the `enable-ecs-log-metadata` FireLens option is not disabled. When you override the FireLens generated config, this filter is removed/ignored. However, the init process will set environment variables with ECS metadata.

### Environment Variables set by init tag

Init sets the following useful env vars:

```
AWS_REGION / ECS_LAUNCH_TYPE / ECS_CLUSTER / ECS_FAMILY
ECS_TASK_ARN / ECS_TASK_ID / ECS_REVISION / ECS_TASK_DEFINITION
```

You can use these to inject metadata values in your config:

```
[FILTER]
    Name record_modifier
    Match *
    Record ecs_task_id ${ECS_TASK_ID}
```

Please review the [init-metadata example](https://github.com/aws-samples/amazon-ecs-firelens-examples/tree/mainline/examples/fluent-bit/init-metadata) for more.

### Configuration Example and Tutorial

For this example, store 4 config files in S3:
- service.conf
- inputs.conf
- filters.conf
- outputs.conf

The configuration in this example is very similar to the [Out of Memory Kill Guide: Full disk buffer example](https://github.com/aws-samples/amazon-ecs-firelens-examples/tree/mainline/examples/fluent-bit/oomkill-prevention#full-firelens-configuration-examples).

The `TODO` notes are left intentionally to note options which you should consider customizing. 

See the [task-definition.json](task-definition.json) and config files in this directory.

#### service.conf

```
[SERVICE]
    Grace         30
    Flush         1
    # TODO: must be write-able path. 
    # https://github.com/aws/aws-for-fluent-bit/blob/mainline/troubleshooting/debugging.md#storagepath-cannot-initialize-root-path
    storage.path  /var/log/flb-storage
    # Total Max Memory Usage <= 2 * # of input definitions * storage.max_chunks_up * 2 MB per chunk
    # 2 MB internal chunk size is not configurable
    # So container memory reservation should be AT LEAST 100 MB
    # TODO: Update limit as needed
    storage.max_chunks_up 25
    # Recommended: enable metrics interface for plugins and storage
    # https://github.com/aws-samples/amazon-ecs-firelens-examples/tree/mainline/examples/fluent-bit/send-fb-internal-metrics-to-cw
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_PORT    2020
    # enable storage metrics
    storage.metrics On
```

#### inputs.conf

```
# This is the required input to recieve container stdout & stderr logs
# with FireLens
[INPUT]
    Name forward
    unix_path /var/run/fluent.sock
    # filesystem buffer for logs collected by this input
    storage.type filesystem
    # pause the input when the [SERVICE] storage.max_chunks_up memory limit is hit?
    storage.pause_on_chunks_overlimit Off # default/recommended value
```

#### filters.conf

```
[FILTER]
    Name record_modifier
    Match *
    Record task_id ${ECS_TASK_ID}
    Record cluster ${ECS_CLUSTER}
    Record service ${ECS_FAMILY}
```

This filter injects metadata into your logs, the final log events in S3 will be JSON objects like the following:

```
{
    "source": "stdout",
    "log": "The actual log line emitted by your app code...",
    "container_id": "e54cccfac2b87417f71877907f67879068420042828067ae0867e60a63529d35",
    "container_name": "/ecs-demo-6-container2-a4eafbb3d4c7f1e16e00"
    "cluster": "mycluster",
    "task_id": "arn:aws:ecs:us-east-2:01234567891011:task/mycluster/3de392df-6bfa-470b-97ed-aa6f482cd7a6",
    "service": "demo_service"
}
```

#### outputs.conf

Please read the [S3 Fluent Bit documentation](https://docs.fluentbit.io/manual/pipeline/outputs/s3).

```
[OUTPUT]
    Name                         s3
    Match                        *
    bucket                       my-bucket
    region                       us-west-2
    total_file_size              50M
    use_put_object               Off
    compression                  gzip
    s3_key_format                /$TAG/%Y/%m/%d/%H_%M_%S.gz
    upload_timeout               10m
    use_put_object               On
```

#### task definition

In the container definition with the AWS for Fluent Bit init image, set the following environment variables to note where you stored your configuration in S3. The ignore env var will tell init to ignore the default generated FireLens configuration. FireLens will still write the generated configuration to disk, but Fluent Bit will not read/uptake it.

The full task definition can be found in this project directory in [task-definition.json](task-definition.json).

```
       {
            "essential": true,
            "image": "public.ecr.aws/aws-observability/aws-for-fluent-bit:init-latest",
            "name": "log_router",
            "firelensConfiguration": {
                "type": "fluentbit"
            },
            "environment": [
                {
                    "name": "aws_fluent_bit_init_s3_1",
                    "value": "arn:aws:s3:::TODO_YOUR_BUCKET/service.conf"
                },
                {
                    "name": "aws_fluent_bit_init_s3_2",
                    "value": "arn:aws:s3:::TODO_YOUR_BUCKET/inputs.conf"
                },
                {
                    "name": "aws_fluent_bit_init_s3_3",
                    "value": "arn:aws:s3:::TODO_YOUR_BUCKET/filters.conf"
                },
                {
                    "name": "aws_fluent_bit_init_s3_4",
                    "value": "arn:aws:s3:::TODO_YOUR_BUCKET/outputs.conf"
                },
                {
                    "name": "aws_fluent_bit_init_ignore_firelens_config",
                    "value": "true"
                }
            ],
        },
```
